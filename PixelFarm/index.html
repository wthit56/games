<!DOCTYPE html>

<html lang="en">
	<head>
		<meta charset="utf-8" />
		<title>Pixel Farm</title>
		<script src="on.js" type="text/javascript"></script>
		<script src="raf-caf.js" type="text/javascript"></script>
		<script src="PixelFarm.js" type="text/javascript"></script>
	</head>
	<body>
		<script type="text/javascript">
  	(function () {
  		var canvas = document.createElement("CANVAS");
  		if (!canvas.getContext || !canvas.getContext("2d")) { throw "Browser does not support 2D Canvas."; }
  	})();

  	var averageColour = (function (image) {
  		var colour = { r: 0, g: 0, b: 0, a: 0, string: "" };

  		var i, l;
  		return function averageColour(imageData, x, y, width, height) {
  			var data = imageData.data;

  			var size = width * height;
  			var dataValueWidth = imageData.width * 4;
  			var valueWidth = width * 4;
  			var right = (x + width) * 4,
  	            last = dataValueWidth * (y + height);

  			i = (y * dataValueWidth) + (x * 4);
  			while (i < last) {
  				colour.r += data[i++];
  				colour.g += data[i++];
  				colour.b += data[i++];
  				colour.a += data[i++];

  				x = (i % dataValueWidth);
  				if (
  	                ((i !== 0) && (x === 0)) ||
  	                (x >= right)
  	            ) { i += dataValueWidth - valueWidth; }
  			}

  			var pixels = width * height;
  			colour.r /= pixels;
  			colour.g /= pixels;
  			colour.b /= pixels;
  			colour.a /= pixels;

  			colour.string = "rgba(" +
  	            Math.round(colour.r) + ", " +
  	            Math.round(colour.g) + ", " +
  	            Math.round(colour.b) + ", " +
  	            (colour.a / 255) +
  	        ")";

  			colour.r = colour.g = colour.b = colour.a = 0;

  			return colour.string;
  		};
  	})();

  	var displayCanvas = document.createElement("CANVAS"),
  	    display = displayCanvas.getContext("2d");

  	var image = new Image(), imageData;

  	var picker = (function () {
  		var picker = document.body.appendChild(document.createElement("SPAN"));
  		var size = picker.size = 20;

  		var centre = ((size + 2) / 2);
  		picker.style.cssText = "" +
  	        "position:absolute;" +
  	        "-webkit-transform:translate(-" + centre + "px, -" + centre + "px);" +
  	        "width:" + size + "px; height:" + size + "px;" +
  	        "border:1px solid black;" +
  	    "";

  		var left, maxLeft,
  	        top, maxTop;

  		picker.loaded = function () {
  			maxLeft = image.width - size;
  			maxTop = image.height - size;
  		};
  		picker.move = function (x, y) {
  			var size = this.size;

  			left = x - (size / 2);
  			left = (left < 0) ? 0 :
  	            (left > maxLeft) ? maxLeft :
  	            left | 0;

  			top = y - (size / 2);
  			top = (top < 0) ? 0 :
  	            (top > maxTop) ? maxTop :
  	            top | 0;

  			this.style.left = (image.offset.x + left + (size / 2)) + "px";
  			this.style.top = (image.offset.y + top + (size / 2)) + "px";

  			document.body.style.backgroundColor = averageColour(image.data, left, top, size, size);
  		}

  		return picker;
  	})();

  	on(image, "load", function () {
  		document.body.appendChild(image);

  		displayCanvas.width = image.width;
  		displayCanvas.height = image.height;
  		display.drawImage(image, 0, 0);

  		image.data = display.getImageData(0, 0, image.width, image.height);
  		image.offset = { x: image.offsetLeft, y: image.offsetTop };

  		picker.loaded();
  		picker.move(Infinity, Infinity);
  	});
  	image.src = "google2.jpg";

  	on(window, "mousemove", function (e) {
  		picker.move(e.pageX - image.offset.x, e.pageY - image.offset.y);
  	});

  	function pickColour(colour) {
  		document.body.style.backgroundColor = colour;
  	}
		</script>
	</body>
</html>
