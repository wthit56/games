<!DOCTYPE html>

<html lang="en">
	<head>
		<meta charset="utf-8" />
		<title>Pixel Farm</title>
		<script src="on.js" type="text/javascript"></script>
		<script src="raf-caf.js" type="text/javascript"></script>
		<script src="PixelFarm.js" type="text/javascript"></script>
	</head>
	<body>
		<script type="text/javascript">
  	(function () {
  		var canvas = document.createElement("CANVAS");
  		if (!canvas.getContext || !canvas.getContext("2d")) { throw "Browser does not support 2D Canvas."; }
  	})();

  	var averageColour = (function (image) {
  		var colour = { r: 0, g: 0, b: 0, a: 0, string: "" };

  		var i, l;
  		return function averageColour(imageData, x, y, width, height) {
  			var data = imageData.data;

  			var size = width * height;
  			var dataValueWidth = imageData.width * 4;
  			var valueWidth = width * 4;
  			var left = x * 4,
  	            top = y * 4,
  	            right = (x + width) * 4,
  	            last = dataValueWidth * (y + height);

  			i = (top * imageData.width) + left;
  			var f = 4000, c = 0;
  			while (--f >= 0) {
  				c++;

  				colour.r += data[i++];
  				colour.g += data[i++];
  				colour.b += data[i++];
  				colour.a += data[i++];

  				if (i > last) { break; }
  				if (i % dataValueWidth > right) { i += dataValueWidth; }
  			}

  			colour.r /= c;
  			colour.g /= c;
  			colour.b /= c;
  			colour.a /= c;

  			colour.string = "rgba(" +
  	            Math.round(colour.r) + ", " +
  	            Math.round(colour.g) + ", " +
  	            Math.round(colour.b) + ", " +
  	            (colour.a / 255) +
  	        ")";

  			colour.r = colour.g = colour.b = colour.a = 0;

  			return colour.string;
  		};
  	})();

  	var displayCanvas = document.createElement("CANVAS"),
  	    display = displayCanvas.getContext("2d");

  	var image = new Image(), imageData;
  	on(image, "load", function () {
  		displayCanvas.width = image.width;
  		displayCanvas.height = image.height;
  		display.drawImage(image, 0, 0);

  		imageData = display.getImageData(0, 0, image.width, image.height);
  		//console.log(averageColour(imageData, 0, 0, 3, 3));

  		init();
  	});
  	image.src = "google2.jpg";

  	var padding = 25, padding2 = padding * 2;
  	var showReticle = false;
  	var point = {
  		x: 0, y: 0,
  		set: function (e) {
  			this.x = Math.min(Math.max(padding, e.pageX - displayCanvas.topLeft.x), image.width - padding);
  			this.y = Math.min(Math.max(padding, e.pageY - displayCanvas.topLeft.y), image.height - padding);
  		}
  	};

  	function init() {
  		displayCanvas.width = image.width + padding2;
  		displayCanvas.height = image.height + padding2;

  		render();
  		display.lineWidth = 0.5;

  		document.body.appendChild(displayCanvas);
  		displayCanvas.topLeft = { x: displayCanvas.offsetLeft, y: displayCanvas.offsetTop };

  		on(displayCanvas, "mouseover", function (e) {
  			showReticle = true;
  			point.set(e);
  			render.schedule();
  		});
  		on(displayCanvas, "mousemove", function (e) {
  			showReticle = true;
  			point.set(e);
  			render.schedule();
  		});
  		on(displayCanvas, "mouseout", function () {
  			showReticle = false;
  			render.schedule();
  		});
  	}

  	var render = (function () {
  		var id = null;

  		function render() {
  			display.clearRect(0, 0, displayCanvas.width, displayCanvas.height);

  			display.drawImage(image, padding, padding);

  			if (showReticle) {
  				display.beginPath();
  				var colour = averageColour(imageData, point.x - padding, point.y - padding, padding2, padding2);
  				display.fillStyle = colour;
  				console.log(colour, display.fillStyle);
  				display.rect(point.x - padding, point.y - padding, padding2, padding2);
  				display.stroke(); display.fill();
  			}
  			else {
  				console.log("no reticle");
  			}

  			id = null;
  		}
  		render.schedule = function () {
  			if (id === null) {
  				id = requestAnimationFrame(render);
  			}
  		};

  		return render;
  	})();
		</script>
	</body>
</html>
